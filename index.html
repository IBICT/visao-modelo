<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Mapa Completo do Sistema de Observatorio</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
	<style>
		html,
body {
    height: 100%;
}

#map {
    width: 100%;
    height: 100%;
    z-index: 1;
    position: fixed;
    top: 0;
    background-color: #132d38;
}

.rangeBarControl .fa-minus {
    position: relative;
    right: 45px;
    top: 14px;
    color: white;
}

.rangeBarControl .fa-plus {
    position: relative;
    left: 190px;
    bottom: 14px;
    color: white;
}

.range-bar {
    position: relative;
    right: 20px;
    height: 10px;
    width: 200px;
    border-radius: 50px;
    background-image: linear-gradient(to right, #e5c75a, #eeb248, #f69b3f, #fc833e, #ff6745);
}
.range-bar-mark {
    position: relative;
    top: -4px;
    left: 0%;
    border: 2px solid whitesmoke;
    border-radius: 50%;
    padding: 0px 7.5px;
    display: none;
}
.select-year {
    position: relative;
    right: 180px;
    bottom: 14px;
    border-radius: 5px 5px 5px 5px;
    outline: none;
    padding-left: 5px;
}
.select-year:hover {
    border-radius: 0 0 5px 5px;
}
.key path {
    display: none;
}
.navbar {
    background-color: rgba(20, 102, 120, 0.8) !important;
    color: white;
    opacity: 0.8;
    z-index: 2;
    top: 0;
    /* display: none; */
}
.navbar nav a {
    color: white;
}
.leaflet-bar button,
.leaflet-bar button:hover,
.input-leaflet {
    color: #59c9a8;
}
.leaflet-top .leaflet-control-layers.leaflet-control {
		position: relative;
    top: 77.8vh;
    width: 30px;
    height: 30px;
}
.leaflet-control-layers-toggle {
	/* background-image: url(../content/images/mapas.png)!important; */ 
	width: 30px !important;
	height: 30px !important;
}
.leaflet-control-layers-expanded:first-child {
    position: absolute !important;
    top: 65.5vh !important;
    width: 180px !important;
    height: 150px !important;

}
.title-popup {
    color: #3d3d3d;
    font-size: 15px;
    font-weight: bold;
}
.button-popup {
    background-color: #146678;
    -webkit-border-radius: 29px;
    border-radius: 29px;
    color: white;
    border: 0;
    padding: 0 10px;
    margin-bottom: 2px;
}
.modal-header {
    background-color: #e5c75a;
    color: white;
}
.modal-header .close {
    color: white;
}
.modal-header .close:hover {
    color: white;
}
@media (min-width: 576px) {
    .modal-dialog {
        max-width: 800px;
    }
}
/* Menu */
.leaflet-top.leaflet-right {
    z-index: 1001 !important;
}
.menu--popup {
    background: #fff;
    position: fixed;
    right: 0px;
    top: 80px;
    width: 340px;
    height: calc(100% - 80px);
    padding: 10px 0.5em 0.5em;
    z-index: 99;
}
.tab-content {
    height: calc(100% - 170px);
}
.nav-tabs {
    border-bottom: 1px solid #59c9a8;
}
.nav-tabs .nav-item {
    margin-bottom: 0;
}
.nav-tabs .nav-link {
    margin-bottom: 0;
    color: #4f4f4f;
    background-color: #f0eded;
    border: none;
}
.nav-tabs .nav-link.active {
    background-color: #fff;
    font-weight: bold;
    color: #59c9a8;
    border-bottom: 1px solid white;
    margin-bottom: -1px;
}
#accordion {
    width: 98%;
}
#accordion .card-body {
    padding: 0rem;
    padding-left: 1.25rem;
    margin-bottom: 1rem;
}
#accordionFilter .card-body {
    padding: 0rem;
    padding-left: 1.25rem;
    margin-bottom: 1rem;
}
#accordionFilter .card-body .form-check-input {
    margin-left: 0rem;
}
.tab-pane {
    overflow-y: scroll;
    height: 100%;
}
.card {
    border: 0;
}
.card-header {
    padding: 0;
}
h5.mb-0 button.btn.btn-link {
    width: 100%;
    height: 100%;
    padding: 12px 6px;
    text-align: left;
    color: #4f4f4f;
    font-weight: bold;
}
.menu {
    font-family: 'Roboto Condensed';
    font-style: normal;
    font-weight: normal;
    font-size: 20px;
    line-height: normal;
    width: 100%;
}
.dropdown-menu.show {
    top: 70px;
    left: -115px
}
.nav-link::after {
    display: none
}
.botao-tam:focus {
    font-family: 'Roboto Condensed';
    font-style: normal;
    font-weight: bold;
    font-size: 20px;
    line-height: 23px;
}
.ajustes {
    position: absolute;
    right: 43%;
    bottom: 35%;
    font-family: 'Roboto Condensed';
}

/* map buttons */

.leaflet-right .leaflet-control:first-child,
.leaflet-left .leaflet-control:first-child {
    margin-top: 80px;
}
.indicadorMapControl div {
    white-space: nowrap;
}
#menuNav {
    padding: 8px 16px;
    height: 56px;
}

#hoverMouse li {
    height: 30px;
    color: #132d38;
    text-align: left;
    background-color: #fff;
    border-radius: 0.15rem;
}
#hoverMouse li a {
    padding-left: 5px;
    padding-right: 5px;
    color: black;
}
#hoverMouse li a:hover {
    text-decoration: none;
    font-weight: bold;
    background-color: #eee9e9;
}
.fa1 {
    font-size: 1.2rem;
}
.margem {
    margin-right: -12px;
}
.color {
    background-color: white;
    color: black;
}
#altura {
    width: 500px;
}
.titulo-login {
    font-family: 'Roboto Condensed';
    font-weight: bold;
    font-size: 25px;
    line-height: 21px;
    color: #146678;
    margin-bottom: 37px;
    margin-top: 11px;
}
.modal-body {
    width: 680px;
    height: 450px;
    background: #F2F2F2;
    box-shadow: -4px 4px 8px rgba(0, 0, 0, 0.15);
    border-radius: 5px;
}
.teste {
    width: 75%;
    height: 86%;
    position: absolute;
    top: 8%;
    left: 12.8%;
}
.input-user {
    border-radius: 15px;
    position: relative;
    left: -2%;
}
.esqueci-senha {
    font-family: 'Roboto';
    position: relative;
    left: 69%;
    font-size: 14.5px;
    color: #BDBDBD !important;

}
.conjunto {
    position: relative;
    top: 20px;
}
.cor {
    font-family: 'Roboto Condensed';
    color: #BDBDBD;
    font-size: 15px;
    font-weight: normal;

}
.btn-margem {
    width: 165px;
    margin-left: 160px;
}
.btn-botao {
    color: white;
    width: 165px
}
.btn-botao:hover {
    color: white
}
.fechar {
    position: absolute;
    top: 5px;
    right: 10px;
    font-size: 27px;
    width: 20px;
}
.popup {
    width: 600px;
    position: relative;

}
.form-group {
    margin-bottom: 25px
}
.linkmodal {
    font-weight: bold;
    color: #856404;
}
.linkmodal:hover {
    text-decoration-color: #856404;
    color: inherit;
}
#loading {
    position: fixed;
    top: 45%;
    left: 45%;
    z-index: 999999;
}
.menuMapControl {
    z-index: 99999;
}
.menuMapControl .nav .nav-item a {
    width: auto;
    height: auto;
    line-height: inherit;
}
.iconFilter {
    cursor: pointer;
    padding: 2.5px 10px;
    color: #00697c;
    background-color: #ffffff;

    border-radius: 15px;
    font-size: 10px;
    margin-left: 10px;
    margin-bottom: 10px;
}
.filtroMapControl {
    width: 300px;
}
.iconInfoFilter {
    padding: 2px 10px;
    color: #17a2b8;
    background-color: #e5c75a;
    border-radius: 15px;
    font-size: 14px;
    margin-left: 10px;
    margin-bottom: 10px;
    margin-right: 10px;
}
.filtroMapControl {
    width: 300px;
}
.infoIndicatorSnippet {
    height: 30px;
    overflow: hidden;
}

/* Icones do menu */
.menu-icon {
    padding: 5px;
}
.robotFamily {
    font-family: 'Roboto';
    font-style: normal;
    font-weight: 500;
    line-height: normal;
}
.filtro-selecionado {
    margin-right: 5px;
    padding: 2px 12px;
    background: #59C9A8;
    border-radius: 10px;
    font-family: 'Roboto';
    font-style: normal;
    font-weight: normal;
    font-size: 12px;
    line-height: 14px;
    color: #FFFFFF;
}
.fa-info {
	background-color: #59C9A8;
	padding: 3.5px 6.5px;
	color: white;
	border-radius: 4px;
	font-size: 8px;
	position: relative;
}
.i-icon {
    margin-right: 5px;
}

#sliderOpacidade {
    -webkit-appearance: none;
    width: 100px;
    margin: 3.5px 0;
    display: inline-block;
    padding-bottom: 3px;
}
#sliderOpacidade:focus {
    outline: none;
}
#sliderOpacidade::-webkit-slider-runnable-track {
    width: 100%;
    height: 2px;
    cursor: pointer;
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
    background: #bdbdbd;
    border-radius: 0px;
    border: 0px solid rgba(1, 1, 1, 0);
}
#sliderOpacidade::-webkit-slider-thumb {
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
    border: 0px solid #000000;
    height: 10px;
    width: 10px;
    border-radius: 50px;
    background: #1e7480;
    cursor: pointer;
    -webkit-appearance: none;
    margin-top: -4px;
}
#sliderOpacidade:focus::-webkit-slider-runnable-track {
    background: #bdbdbd;
}
#sliderOpacidade::-moz-range-track {
    width: 100%;
    height: 2px;
    cursor: pointer;
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
    background: #bdbdbd;
    border-radius: 0px;
    border: 0px solid rgba(1, 1, 1, 0);
}
#sliderOpacidade::-moz-range-thumb {
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
    border: 0px solid #000000;
    height: 10px;
    width: 10px;
    border-radius: 50px;
    background: #1e7480;
    cursor: pointer;
}
#sliderOpacidade::-ms-track {
    width: 100%;
    height: 2px;
    cursor: pointer;
    background: transparent;
    border-color: transparent;
    color: transparent;
}
#sliderOpacidade::-ms-fill-lower {
    background: #bdbdbd;
    border: 0px solid rgba(1, 1, 1, 0);
    border-radius: 0px;
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
}
#sliderOpacidade::-ms-fill-upper {
    background: #bdbdbd;
    border: 0px solid rgba(1, 1, 1, 0);
    border-radius: 0px;
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
}
#sliderOpacidade::-ms-thumb {
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0), 0px 0px 0px rgba(13, 13, 13, 0);
    border: 0px solid #000000;
    height: 10px;
    width: 10px;
    border-radius: 50px;
    background: #1e7480;
    cursor: pointer;
    height: 2px;
}
#sliderOpacidade:focus::-ms-fill-lower {
    background: #bdbdbd;
}
#sliderOpacidade:focus::-ms-fill-upper {
    background: #bdbdbd;
}

#footer-sidebar-filtros {
    position: absolute;
    bottom: 0px;
    right: 0px;
    height: 140px;
    width: 100%;
    background-color: #f5f6f6;
    box-shadow: 0px -1px 5px rgba(0, 0, 0, 0.2);
    border-top: 2px solid #59c9a8;
}

.custom-control-label::before {
    background-color: #fff;
    border: 1px solid #4f4f4f;
    outline-width: 0;
}

.custom-radio .custom-control-input:checked ~ .custom-control-label::before {
    background-color: #fff;
    border: 1px solid #59c9a8;
}

.custom-control-input:checked ~ .custom-control-label::before {
    background-color: #fff;
    border: 1px solid #59c9a8;
}

.custom-checkbox .custom-control-input:checked ~ .custom-control-label::before {
    background-color: #fff;
    border: 1px solid #59c9a8;
}

.custom-control-input:checked ~ .custom-control-label::before {
    background-color: #fff;
    border: 1px solid #59c9a8;
}

.leaflet-container {
    font-family: 'Roboto Condensed';
}

.robotoFamily {
    font-family: 'Roboto' !important;
}

.custom-radio .custom-control-input:checked ~ .custom-control-label::after {
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3E%3Ccircle r='3' fill='%2359C9A8'/%3E%3C/svg%3E");
}

.custom-checkbox .custom-control-input:checked ~ .custom-control-label::after {
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Cpath fill='%2359C9A8' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3E%3C/svg%3E");
}

.leaflet-touch .leaflet-control-layers,
.leaflet-touch .leaflet-bar {
    border: none !important;
}
.loader {
    position: relative;
    top: 50%;
    left: 50%;
    -webkit-transform: translate(-50%, -50%);
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    background-color: #146678;
    border-radius: 50%;
}
.loader:after {
    content: '';
    position: absolute;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    border: 0px solid white;
    -webkit-transform: translate(-50%, -50%);
    transform: translate(-50%, -50%);
    -webkit-animation: loading 500ms ease-out forwards infinite;
    animation: loading 500ms ease-out forwards infinite;
}

@-webkit-keyframes loading {
    0% {
        border: 0px solid white;
    }
    20% {
        border: 8px solid white;
        width: 0%;
        height: 0%;
    }
    100% {
        border: 8px solid white;
        width: 100%;
        height: 100%;
    }
}

@keyframes loading {
    0% {
        border: 0px solid white;
    }
    20% {
        border: 8px solid white;
        width: 0%;
        height: 0%;
    }
    100% {
        border: 8px solid white;
        width: 100%;
        height: 100%;
    }
}

	</style>


</head>
<body>
    <div id="map">
        <div id ="loading" class="loader"></div>
    </div>

	<!-- Modal -->
	<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="tituloModal" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <input id="idInfoIndicador" type="number" style="display: none;">
              <h5 class="modal-title" id="tituloModal">DETALHAMENTO DE DADOS</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="modalBody">           
              <div id="modalEstadoValor"></div>
              <span>HABITANTES<br /><span id="modalHabitantesValor"></span></span><br />
              <br />
              <span>PIB<br /><span id="modalPIBValor"></span></span><br />
              <span>PIB per capita<br /><span id="modalPibPerCapita"></span></span><br />
              <br />
              <span>Rendimento<br /><span id="modalRendimentoValor"></span></span>
              <span>MÉDIO<br /></span>
              <span id="modalRendimentoMedioF"></span><br />
              <span id="modalRendimentoMedioM"></span><br />
              <br />
              <span>SUPERIOR COMPLETO<br /><span id="modalSuperiorCompletoValor"></span></span><br />
            </div>
            <!--<div class="modal-footer">-->
            <!--</div>-->
          </div>
        </div>
      </div>
	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<script>

const host = "http://localhost:3000";
var apiKey = window.sessionStorage.getItem('jhi-authenticationtoken');
if(apiKey){
apiKey = apiKey.substring(1, apiKey.length - 1);
}
//console.log(apiKey);

// Iniciar mapa objeto sem zoom, latitude, longitude, zoom inicial
var map = L.map('map', {
        zoomControl:false,
        doubleClickZoom: false
    }).setView([-15, -50], 4);
// map.setMaxBounds(map.getBounds());

var cookies = document.cookie.split(';');
var existeCookie = false;
cookies.forEach(function (cookie) {
    if(cookie === " logged=true"){
        $('.show-logado').show();
        $('.show-deslogado').hide();
        existeCookie = true;
    }
});
if(!existeCookie) {
    $('.show-logado').hide();
    $('.show-deslogado').show();
}

var baseLayers = {
    'Gao De Image': L.layerGroup([L.tileLayer('http://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
        subdomains: "1234"
    }), L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
        subdomains: "1234"
    })]),
    "Mapa tridimensional": L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
	    maxZoom: 18,
	    id: 'mapbox.satellite'
    }),
	'GeoQ': L.tileLayer('http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}'),
    "Mapa escuro": L.layerGroup([L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png', {
        subdomains: "1234"
    }), L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}.png', {
        subdomains: "1234"
    })]),
	"Mapa claro": L.layerGroup([L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
        subdomains: "1234"
    }), L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
        subdomains: "1234"
    })])
    .addTo(map)
};

var layercontrol = L.control.layers(baseLayers,{}, {
    position: "topleft"
}).addTo(map);

markers = L.markerClusterGroup({ chunkedLoading: true });

var group = new L.FeatureGroup();

var arrayCompleto, municipioArray, estadoArray;
var indicatorArray, filterArray, years;
var estado, mesoRegiao, municipio;
var maxValue, minValue, midValue, categories, indicatorNames, groupLayer;
var indicadorMapControl, filtroMapControl, limparMapControl, rangeBarControl, mapControl, botao2, botao3;
var filtrosId, layersId;
var indicadorSelecionado;
var filtrosPesquisados = new Map();
var indicadorAtual;
var istance;

getGeoJson();
$(".leaflet-right.leaflet-bottom").css('right', '340px');

function modalDetail(data){
	$('#modalEstadoSigla').html(data);
    $('#modalHabitantesValor').html("3.873.743");
    $('#modalEstadoValor').html("AM");
    $('#modalPIBValor').html("R$88668");
    $('#modalPibPerCapita').html("R$10");
    $('#modalRendimentoMedioF').html("R$20");
    $('#modalRendimentoMedioM').html("R$25");
    $('#modalSuperiorCompletoValor').html("%2.5");
    $('#exampleModal').modal('show');
}

function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
};


function getGeoJson(){
	//usage in request
	
	//console.log(getUrlParameter('grupCategory'));
	/*
	$.ajax({
		url: host+'/api/grup-categories/'+getUrlParameter('grupCategory'),
		dataType: 'json',
		success: function(data) {
			console.log(data);
		}
	});
	*/
	
	//http://teste.visao.ibict.br/api/categories?id.in=1&id.in=2&id.in=3&id.in=4
	/*

	var already_loaded = new Object();  // used to track which accordions have already been loaded

$(function() {
    $( "#accordion" ).accordion({
        collapsible: true,
        active: false,
        //heightStyle: 'fill', // http://jqueryui.com/accordion/#fillspace  -- Just sets the height of the accordion to the height of it's parent container.  We need a way to change the height of the parent to that of the newly added content.
        activate: function (e, ui) {
            // only fire when the accordion is opening..
            if(ui.newHeader.length>0){                
                // only retrieve the remote content once..
                if(! already_loaded[ui.newHeader[0].id]==1){
                    var srcObj = $(ui.newHeader[0]).children('a');
                    var url = srcObj.attr('href');
                    var folder = srcObj.attr('data-folder');
                    //$.get(url, function (data){  // if you wanted to use the GET method uncomment this and comment the next line.  Be sure to add any needed query string parameters to the URL.
                    $.post(url, {doCmd:'getFolderFiles', folder:srcObj.attr('data-folder')}, function (data){
                        $(ui.newHeader[0]).next().html(data);
                        var contentDiv = $(ui.newHeader[0]).next()[0];
                        $('#'+contentDiv.id).height(contentDiv.scrollHeight);
                        //$("#accordion").accordion("refresh"); // http://api.jqueryui.com/accordion/#method-refresh -- The documentation isn't clear on this but this only refreshes added/removed panels.  Does not refresh existing panels with newly added content.
                        already_loaded[ui.newHeader[0].id]=1; // keep track of the loaded accordions
                    });
                }
            }
        }

    });

});
	
	
	*/
	$.ajax({
		url: host+'/api/grup-categories/'+getUrlParameter('grupCategory'),
		dataType: 'json',
		success: function(data) {
			istance = data;
			categories = istance.categories;
			//var urlIndicator = '';
			//console.log(categories);
			
			categories.filter(function (categoria) {
				return categoria.type === 'INDICATOR';
			}).forEach(function(item) {
				$.ajax({
					headers: {
						"Authorization": "Bearer " + apiKey
					},
					url: host+'/api/grup-indicators?categoryId.equals='+item.id,
					dataType: 'json',
					success: function(data) {
						indicatorNames = data;
						//console.log(data);
						item['grup-indicators'] = data;
					}
				});
			});
			categories.filter(function (categoria) {
				return categoria.type === 'FILTER';
			}).forEach(function(item) {
				$.ajax({
					headers: {
						"Authorization": "Bearer " + apiKey
					},
					url: host+'/api/geographic-filters?categoryId.equals='+item.id,
					dataType: 'json',
					success: function(data) {
						indicatorNames = data;
						//console.log(data);
						item['geographic-filters'] = data;
					}
				});
			});
			categories.filter(function (categoria) {
				return categoria.type === 'LAYER';
			}).forEach(function(item) {
				$.ajax({
					headers: {
						"Authorization": "Bearer " + apiKey
					},
					url: host+'/api/group-layers?categoryId.equals='+item.id,
					dataType: 'json',
					success: function(data) {
						indicatorNames = data;
						//console.log(data);
						item['group-layers'] = data;
					}
				});
			});
			console.log(categories);
			//urlIndicator = urlIndicator.replace('&','?');
			//console.log(urlIndicator);
			$.ajax({
				url: host+'/map/estado.json',
				dataType: 'json',
				success: function(data) {
					estado = data;
					$.ajax({
						url: host+'/map/municipio.json',
						dataType: 'json',
						success: function(data) {
							municipio = data;
							makeMap();
						}
					});
				}
			});
		}
	});
}

function genereteListIndicators(){
	var indicatorCategory = '';
	categories.filter(function (categoria) {
        return categoria.type === 'INDICATOR';
    }).forEach(function(item) {

		indicatorCategory += 	'					<div style="border-bottom: 1px solid #E0E0E0;" class="card">' +
								'						<div style="border: 0;" class="card-header" id="headingCard'+ item.id +'">' +
								'							<h5 class="mb-0">' +
								'								<button style="background-color: #fff;" class="btn btn-link" data-toggle="collapse" data-target="#collapse'+ item.id  +'" aria-expanded="true" aria-controls="collapseOne">' +
								'									<div class="robotoFamily " style="display: inline-block; text-overflow: ellipsis; overflow: hidden; width: 200px; height: 18px; white-space: nowrap;" title="'+ item.name +'">'+ item.name +' </div><i class="pull-right fa fa-angle-right" aria-hidden="true"></i>' +
								'								</button>' +
								'							</h5>' +
								'						</div>' +
								'						<div id="collapse'+ item.id  +'" class="collapse" aria-labelledby="headingCard'+ item.id +'" data-parent="#accordion">' +
								'							<div class="card-body">';

		item['grup-indicators'].forEach(function(indicator) {
            indicatorCategory += 	'								<div class="form-check">' +
                                    '                                   <div class="custom-control custom-radio">' +
                                    '                                       <input type="radio" id="indicador'+ indicator.id +'" name="indicator" class="custom-control-input form-check-input" value="'+indicator.id+'">' +
                                    '                                       <label class="custom-control-label form-check-label robotoFamily" for="indicador'+ indicator.id +'">'+ indicator.name +'</label>' +
                                    '                                   </div>' +
									'								</div>';
		});

		indicatorCategory +=	'							</div>' +
								'						</div>' +
								'					</div>';
	});
	return indicatorCategory;
}

function generateListFilters(){
    var filterCategory = '';

    categories.filter(function (categoria) {
        return categoria.type === 'FILTER';
    }).forEach(function(item) {
        filterCategory +=
            '<div style="border-bottom: 1px solid #E0E0E0;" class="card">' +
            '   <div style="border: 0;" class="card-header" id="headingCard'+ item.id +'">' +
            '	    <h5 class="mb-0">' +
            '		    <button style="background-color: #fff;" class="btn btn-link" data-toggle="collapse" data-target="#collapse'+ item.id  +'" aria-expanded="true" aria-controls="collapseOne">' +
            '			    <div class="robotoFamily" style="display: inline-block; text-overflow: ellipsis; overflow: hidden; width: 200px; height: 18px; white-space: nowrap;" title="'+ item.name +'">'+ item.name +' </div><i class="pull-right fa fa-angle-right" aria-hidden="true"></i>' +
            '			</button>' +
            '		</h5>' +
            '	</div>' +
            '   <div id="collapse'+ item.id  +'" class="collapse" aria-labelledby="headingCard'+ item.id +'" data-parent="#accordionFilter">' +
            '	    <div class="card-body">';

        item['geographic-filters'].forEach(function(item) {
            filterCategory +=
                '       <div class="form-check-input" style="display: contents">'+
                '           <div class="custom-control custom-checkbox">'+
                '               <input type="checkbox" value="'+item.id+'" name="filtro"  class="filterCheckbox robotoFamily custom-control-input" id="checkbox-'+item.id+'">'+
                '               <label class="custom-control-label" style="line-height:24px" for="checkbox-'+item.id+'">'+item.name+'</label>'+
                '           </div>'+
                '       </div><br />';
        });
        filterCategory +=
            '       </div>' +
            '	</div>' +
            '</div>';
    });
	return filterCategory;
}


function genereteListLayer(){
    var layerCategory = '';
    categories.filter(function (categoria) {
        return categoria.type === 'LAYER';
    }).forEach(function(item) {

        layerCategory += 	'					<div style="border-bottom: 1px solid #E0E0E0;" class="card">' +
            '						<div style="border: 0;" class="card-header" id="headingCardLayer'+ item.id +'">' +
            '							<h5 class="mb-0">' +
            '								<button style="background-color: #fff;" class="btn btn-link" data-toggle="collapse" data-target="#collapsLayere'+ item.id  +'" aria-expanded="true" aria-controls="collapseOne">' +
            '									<div class="robotoFamily" style="display: inline-block; text-overflow: ellipsis; overflow: hidden; width: 200px; height: 18px; white-space: nowrap;" title="'+ item.name +'">'+ item.name +' </div><i class="pull-right fa fa-angle-right" aria-hidden="true"></i>' +
            '								</button>' +
            '							</h5>' +
            '						</div>' +
            '						<div id="collapsLayere'+ item.id  +'" class="collapse" aria-labelledby="headingCardLayer'+ item.id +'" data-parent="#accordion">' +
            '							<div class="card-body">';

        item['group-layers'].forEach(function(layer) {
            layerCategory += 	'				<div class="form-check">' +
                '                                   <div class="custom-control custom-checkbox">' +
                '									    <input class="custom-control-input form-check-input layerCheckbox" name="layerCheckbox" type="checkbox" value="'+ layer.id +'" id="layer'+ layer.id +'" />' +
                '    									<label class="custom-control-label form-check-label robotoFamily" for="layer'+ layer.id +'">' +
                '										    '+ layer.name +
                '									    </label>' +
                '                                   </div>' +
                '								</div>';
        });

        layerCategory +=	'							</div>' +
            '						</div>' +
            '					</div>';

    });
    return layerCategory;
}

// Choropleth map

// Retorna o valor da regiao em Float, passando o geoCode e o Array de dados
function matchKey(datapoint, key_variable){
    return(key_variable[datapoint]);
};

getGradientColor = function(start_color, end_color, percent) {
   // strip the leading # if it's there
   start_color = start_color.replace(/^\s*#|\s*$/g, '');
   end_color = end_color.replace(/^\s*#|\s*$/g, '');

   // convert 3 char codes --> 6, e.g. `E0F` --> `EE00FF`
   if(start_color.length == 3){
     start_color = start_color.replace(/(.)/g, '$1$1');
   }

   if(end_color.length == 3){
     end_color = end_color.replace(/(.)/g, '$1$1');
   }

   // get colors
   var start_red = parseInt(start_color.substr(0, 2), 16),
       start_green = parseInt(start_color.substr(2, 2), 16),
       start_blue = parseInt(start_color.substr(4, 2), 16);

   var end_red = parseInt(end_color.substr(0, 2), 16),
       end_green = parseInt(end_color.substr(2, 2), 16),
       end_blue = parseInt(end_color.substr(4, 2), 16);

   // calculate new color
   var diff_red = end_red - start_red;
   var diff_green = end_green - start_green;
   var diff_blue = end_blue - start_blue;

   diff_red = ( (diff_red * percent) + start_red ).toString(16).split('.')[0];
   diff_green = ( (diff_green * percent) + start_green ).toString(16).split('.')[0];
   diff_blue = ( (diff_blue * percent) + start_blue ).toString(16).split('.')[0];

   // ensure 2 digits by color
   if( diff_red.length == 1 ) diff_red = '0' + diff_red
   if( diff_green.length == 1 ) diff_green = '0' + diff_green
   if( diff_blue.length == 1 ) diff_blue = '0' + diff_blue

   return '#' + diff_red + diff_green + diff_blue;
};

// get color depending on population density value
function getColor(d) {
	if(d >= minValue && d <= midValue){
		return getGradientColor('#e5c75a', '#f69b3f', (d - minValue) / (midValue - minValue));
	}else if (d > midValue && d <= maxValue) {
		return getGradientColor('#f69b3f', '#ff6745', (d - midValue) / (maxValue - midValue));
	}
	return '#CBD8DD';
}

// Retorna a porcetatem para a barra de range de valores
function getPercent(d) {
	return ((d - minValue) / (maxValue - minValue)) * 100;
}

// pinta a regiao
function style_1(feature) {
	return {
		fillColor: getColor(matchKey(feature.geoCode, indicatorArray)),
		weight: (feature.geoCode.toString().length > 2) ? 0.1 : 1,
		opacity: 1,
		color: '#146678',
		fillOpacity: 0.8
	};
}
// Choropleth map

// Funcao para retornar o menor valor de um array
Array.min = function(array) {
	return Math.min.apply(Math, array);
};

// Funcao para retornar o maior valor de um array
Array.max = function(array) {
	return Math.max.apply(Math, array);
};

// Funcao para setar os valores das variaveis com base no json
function setJsonVars(json) {
	var values = Object.values(json);
	minValue = Array.min(values);
	maxValue = Array.max(values);
	midValue = (maxValue + minValue) / 2;
}

// MenuMapControl
function menuMapControl(){
    let pos = ($(".menu--popup").css('right') == '0px') ? '-340px' : '0';
    $(".menu--popup").animate({right: pos}, 800);
    let pos2 = ($(".leaflet-right.leaflet-bottom").css('right') == '0px') ? '340px' : '0';
    $(".leaflet-right.leaflet-bottom").animate({right: pos2}, 800);
    $('#seta-sidebar').toggle();
}

function rangeMap(select){
    console.log(select.value);
    switch(select.value) {
        case "3":
            makeChart(3);
            break;
        case "2":
            makeChart(2);
            break;
        case "1":
            makeChart(1);
            break;
    }
}

function cleanMap(){
	map.removeLayer(group);
	if (typeof(indicadorMapControl) != "undefined") {
		indicadorMapControl.remove(map);
        filtroMapControl.remove(map);
		rangeBarControl.remove(map);
		mapControl.remove(map);
	}
}

function emptyMap(){
	indicatorArray = new Array();
    var route1Layer = L.geoJson(estado,
	{
		style: style_1

	});
	group.addLayer(route1Layer);
	map.addLayer(group);
}

// Set no mapa arquivo de regiões, função de popup nas regiões
function makeChart(rangeMap2) {

	var geoJson;
	switch(rangeMap2) {
		case 2:
			geoJson = municipio;
			indicatorArray = municipioArray;
		break;
		case 1:
			geoJson = estado;
			indicatorArray = estadoArray;
		break;
	}

	setJsonVars(indicatorArray);

	var route1Layer = L.geoJson(geoJson,
	{
		style: style_1,
		onEachFeature: function (feature, layer) {
			if (typeof indicatorArray[feature.geoCode] !== "undefined") {

			    var popupValue = '<div onclick="modalDetail(\''+feature.geoCode+'\')">' +
                    '<p id="box_'+feature.geoCode+'" class="title-popup">'+feature.properties.name+'</p>' +
                    '<p id="both" style="margin-bottom: 0">'+arrayCompleto[0].group.name+'</p>' +
                    '<p style="font-size: 16px; margin-top: 0; font-weight: bold">'+getFormattedPrintValue(arrayCompleto[0].group.typePresentation, indicatorArray[feature.geoCode])+'</p>' +
                    '<div style="text-align: center">';

			    var filtrosAplicados = filtrosPesquisados.get(parseInt(feature.geoCode));
			    if(filtrosAplicados !== undefined){
                    filtrosAplicados.forEach(function (filterName) {
                        popupValue += '<button class="button-popup">'+filterName+'</button></br>';
                    });
                }
			    popupValue += '</div> </div>';

				layer.bindPopup(popupValue);

				layer.on('mouseover', function (e) {
					var x = document.getElementsByClassName("range-bar-mark")[0];
                    x.style.left = getPercent(indicatorArray[feature.geoCode])*0.92+"%";
					x.style.display = "inline";
					$("#box"+feature.geoCode).toggle();
				});
				layer.on('mouseout', function (e) {
					var x = document.getElementsByClassName("range-bar-mark")[0];
					x.style.display = "none";
                    $("#box"+feature.geoCode).toggle();
				});
			} else {
                var popupValue = '<div>' +
                    '<p id="box_'+feature.geoCode+'" class="title-popup">'+feature.properties.name+'</p>' +
                    '<p id="both" style="margin-bottom: 0">'+arrayCompleto[0].group.name+'</p>' +
                    '<p style="font-size: 16px; margin-top: 0; font-weight: bold">Não há dados sobre a região selecionada nesse período.</p>' +
                    '<div style="text-align: center">' +
                    '</div> </div>';
				layer.bindPopup(popupValue);
            }
		}
	});

	$("#loading").hide();

	group.addLayer(route1Layer);
	map.addLayer(group);

	function getFormattedPrintValue(typePresentation, valueToShow){
	    if(typePresentation !== null && typePresentation.display.includes("$")){
	        return typePresentation.display + valueToShow.toLocaleString('pt-br', {minimumFractionDigits: 2});
        } if(isJson(typePresentation.display)) {
			var display = JSON.parse(typePresentation.display);
            return display[valueToShow];
        }
		else {
            return valueToShow.toLocaleString('pt-br');
        }
    }
}

function updateOpacity(value) {
    group.setStyle({fillOpacity:value});
}

function isJson(item) {
    item = typeof item !== "string"
        ? JSON.stringify(item)
        : item;

    try {
        item = JSON.parse(item);
    } catch (e) {
        return false;
    }

    if (typeof item === "object" && item !== null) {
        return true;
    }

    return false;
}


function setLayer(json){
	json.forEach(function(item) {
		switch(item.type){
			case "MARKER":
				var latlong = JSON.parse(item.geoJson);
				var marker = new L.Marker(latlong);
				let desc = '';
				desc += ((typeof item.name === 'string' || item.name instanceof String) && item.name.length !== 0)
								? "Nome: " + item.name + "<br />" : '';
				desc += ((typeof item.description === 'string' || item.description instanceof String) && item.description.length !== 0)
								? "Descrição: " + item.description + "<br />" : '';
				desc += ((typeof item.source === 'string' || item.source instanceof String) && item.source.length !== 0)
								? "Fonte: " + item.source + "<br />" : '';
				desc += ((typeof item.note === 'string' || item.note instanceof String) && item.note.length !== 0)
								? "Notas: " + item.note + "<br />" : '';
				marker.bindPopup(desc);
  				markers.addLayer(marker);
			break;
			case "CIRCLE":
				var circle = JSON.parse(item.geoJson);
				L.circle(circle.latlong, {
					color: 'red',
					fillColor: '#f03',
					fillOpacity: 0.5,
					radius: circle.radius
				}).addTo(mymap);

			break;
			case "POLYGON":
				var polygon = JSON.parse(item.geoJson);
				L.polygon(polygon).addTo(mymap);
			break;
			case "ICON":
                var latlong = JSON.parse(item.geoJson);
				var greenIcon = L.icon({
					iconUrl: 'leaf-green.png',
					shadowUrl: 'leaf-shadow.png',

					iconSize:     [38, 95], // size of the icon
					shadowSize:   [50, 64], // size of the shadow
					iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
					shadowAnchor: [4, 62],  // the same for the shadow
					popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
                });
                var marker = new L.Marker(latlong, {icon: greenIcon});
  				markers.addLayer(marker);
			break;
		}
	});
	map.addLayer(markers);
}

function setYears(nameId) {
    var yearsOptions = '';
    $.ajax({
		headers: {
			"Authorization": "Bearer " + apiKey
		},
        url: host+'/api/yearsDistinct?&groupId.equals='+nameId,
        dataType: 'json',
        async: false,
        success: function (data) {
            data.forEach(function(item) {
                yearsOptions += '<option value="' + item.id +'">' + item.date + '</option>';
            });
        }
    });
    return yearsOptions;
}

function changeYear(yearOption){
	map.removeLayer(group);

	var urlQuery = '';
	if(filtrosId.size === 0){
		urlQuery += host+'/api/indicators?yearId.equals='+yearOption.value+'&groupId.equals='+indicadorAtual;
	} else {
		var vetor = new Array();
		filtrosId.forEach(function (filtro) {
			vetor.push(filtro);
		});
		var stringResult = vetor.join(',');
		urlQuery += host+'/api/indicatorsFilter?yearId.equals='+yearOption.value+'&filtersId.in='+stringResult+'&groupId.equals='+indicadorAtual;

		$.ajax({
			headers: {
				"Authorization": "Bearer " + apiKey
			},
			url: host+'/api/regionsWithFilter?yearId.equals='+yearOption.value+'&filtersId.in='+stringResult,
			dataType: 'json',
			success: function (dataJson) {
				filtrosPesquisados = new Map();
				dataJson.forEach(function (dto) {
					var contains = filtrosPesquisados.get(dto.geocode);
					if(contains === undefined){
						filtrosPesquisados.set(dto.geocode, []);
						contains = filtrosPesquisados.get(dto.geocode);
					}

					contains.push(dto.filtername);
				});
			}
		});
	}

	console.log(urlQuery);
	$.ajax({
		headers: {
			"Authorization": "Bearer " + apiKey
		},
		url: urlQuery,
		//timeout: 10000,
		//error: function (xhr, ajaxOptions, thrownError) {
		//	alert(xhr.status);
		//	alert(thrownError);
		//},
		dataType: 'json',
		success: function (dataJson) {

			if (dataJson.length < 1) {
				$("#loading").hide();
				emptyMap();
			}
			else {
				arrayCompleto = dataJson;
				console.log(arrayCompleto);
				municipioArray = new Array();
				estadoArray = new Array();

				dataJson.forEach(function (indicator) {

					if (indicator.region.typeRegion == "MUNICIPIO") {
						municipioArray[indicator.region.geoCode.toString()] = indicator.value;
					} else if (indicator.region.typeRegion == "ESTADO") {
						estadoArray[indicator.region.geoCode.toString()] = indicator.value;
						return;
					}
				});

				itensSelect[0] = '<option value="1">Estado</option>';
				itensSelect[1] = '<option value="2">Municipio</option>';

				if (estadoArray.length > 0) {
					if (municipioArray.length < 1){
						delete itensSelect[1];
					}
					makeChart(1);
				} else if (municipioArray.length > 0) {
					delete itensSelect[0];
					makeChart(2);
				} else {
					console.error("Empty DATAJSON")
				}
			}
		}
	});
}

function limparMap() {
	location.reload();
}

function makeMap() {

	$("#loading").hide();

	emptyMap();

	//Functions to either disable (onmouseover) or enable (onmouseout) the map's dragging
	function controlEnter(e) {
		map.dragging.disable();
        map.scrollWheelZoom.disable();
	}
	function controlLeave() {
		map.dragging.enable();
		map.scrollWheelZoom.enable();
	}

	// Menu Map control
	var menuMapControl = L.control({position: 'topright'});
	menuMapControl.onAdd = function(map) {
				this._div = L.DomUtil.create('div', 'leaflet-bar easy-button-container menuMapControl');
				this._div.innerHTML = '<div>' +
									  '<div style="border-radius:4px; background-color: rgba(255,255,255,0.9); color: #59C9A8; font-size: 28px; padding: 1px 10px;" onclick="menuMapControl()"><i class="fa fa-sliders"></i></div>' +
									  '	<div class="menu--popup">' +
									  '		<ul class="nav nav-tabs" id="myTab" role="tablist">' +
									  '			<li class="nav-item">' +
									  '				<a class="nav-link active robotoFamily" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">INDICADORES</a>' +
									  '			</li>' +
									  '			<li class="nav-item">' +
									  '				<a class="nav-link robotoFamily" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">FILTROS</a>' +
									  '			</li>' +
									  '			<li class="nav-item">' +
									  '				<a class="nav-link robotoFamily" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">CAMADAS</a>' +
									  '			</li>' +
									  '		</ul>' +
									  '		<div class="tab-content" id="myTabContent">' +
									  '			<div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">' +
									  '				<div id="accordion">' +
														genereteListIndicators() +
									  '				</div>' +
									  '			</div>' +
									  '			<div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">' +
									  '				<div id="accordionFilter">' +
                                                        generateListFilters() +
									  '				</div>'+
                                      '             <div id="selectedIndicator" style="text-align: center;"><span> Não há indicador selecionado</span></div>' +
									  '			</div>' +
									  '			<div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">' +
														genereteListLayer() +
												'</div>' +
									  '		</div>' +
									  '		<span id="seta-sidebar" onclick="menuMapControl()" style="position:absolute;left: -40px;top: 0;color:white;background-color: #59C9A8;padding: 4px 12px;border-radius:4px 0 0 4px;font-size: 22px;"><span class="fa fa-chevron-right"> </span></span>' +
                                      '		<div id="footer-sidebar-filtros">' +
                                      '		    <div class="pull-left" style="width:60%;min-height:1px;margin-top:20px">' +
                                      ' 		    <div class="indicador" style="text-align:center"></div>' +
                                      '     		<div class="filtro" style="margin: 10px 45px 0 0;"></div>' +
                                      '		    </div>' +
                                      '		    <div class="pull-left" style="width:40%;padding-right:20px">' +
									  '    		    <button id="submitFormIndicator" disabled style="margin: 15px 15px 0; background-color: #146678; color: #fff;" class="btn pull-right robotoFamily">Aplicar</button><br>' +
                                      '       		<button id="clearFormIndicator" style="margin: 0 5px; background-color: #f5f6f6; color: #146678;" class="btn pull-right robotoFamily">Limpar&nbsp;<span class="fa fa-trash-o"></span></button>' +
                                      '		    </div>' +
                                      '		</div>' +
									  '	</div>' +
									  '</div>';


					L.DomEvent.addListener(this._div, 'dblclick', L.DomEvent.stop);

				return this._div;jhiTranslate="global.menu."
	}
	menuMapControl.addTo(map);

	document.getElementsByClassName("menuMapControl")[0].onmouseover = controlEnter;
	document.getElementsByClassName("menuMapControl")[0].onmouseout = controlLeave;

	$('#accordion .card').on('hidden.bs.collapse', function () {
		$(this).find( "i" ).removeClass("fa-angle-down");
		$(this).find( "i" ).addClass("fa-angle-right");
	});

	$('#accordion .card').on('shown.bs.collapse', function () {
		$(this).find( "i" ).addClass("fa-angle-down");
		$(this).find( "i" ).removeClass("fa-angle-right");
	});

	$('#accordionFilter .card').on('hidden.bs.collapse', function () {
		$(this).find( "i" ).removeClass("fa-angle-down");
		$(this).find( "i" ).addClass("fa-angle-right");
	});

	$('#accordionFilter .card').on('shown.bs.collapse', function () {
		$(this).find( "i" ).addClass("fa-angle-down");
		$(this).find( "i" ).removeClass("fa-angle-right");
	});

	$('input[type=radio][name=indicator]').change(function() {
		indicadorAtual = this.value;
        indicadorSelecionado = indicadorAtual;
        $('#selectedIndicator').html("<span id='msgIndicadorSelecionado'>Indicador <b>"+$(this.nextElementSibling).text().trim()+"</b> selecionado</span>");
		$('#submitFormIndicator').prop('disabled', false);
	});

	$('input[type=checkbox][name=filtro]').change(function () {
        if($('.layerCheckbox:checked').val() !== undefined){
            $('#submitFormIndicator').prop('disabled', false);
        }
    });

	$('input[type=checkbox][name=layerCheckbox]').change(function () {
        if($('input[type=checkbox][name=layerCheckbox]:checked').length > 0)
            $('#submitFormIndicator').prop('disabled', false);
        else if($('input[type=radio][name=indicator]:checked').val() === undefined)
            $('#submitFormIndicator').prop('disabled', true);
    });

	// Method to clear the lateral form
	$('#clearFormIndicator').click(function () {
        $('.menu--popup').find(':input').each(function () {
            if(this.type === 'checkbox' || this.type === 'radio'){
                this.checked = false;
            }
        });

        indicadorAtual = undefined;
        $('#selectedIndicator').html("<span> Não há indicador selecionado</span>");
        $('#submitFormIndicator').prop('disabled', true);
    });

    function loadResultMap(urlQuery) {
        $.ajax({
			headers: {
				"Authorization": "Bearer " + apiKey
			},
            url: urlQuery,
			//timeout: 10000,
			//error: function (xhr, ajaxOptions, thrownError) {
			//	alert(xhr.status);
			//	alert(thrownError);
			//},
            dataType: 'json',
            success: function (dataJson) {

                if (dataJson.length < 1) {
                    $("#loading").hide();
                    emptyMap();
                }
                else {
                    arrayCompleto = dataJson;
					console.log(arrayCompleto);
                    municipioArray = new Array();
                    estadoArray = new Array();

                    //console.log(dataJson);

                    dataJson.forEach(function (indicator) {

                        if (indicator.region.typeRegion == "MUNICIPIO") {
                            municipioArray[indicator.region.geoCode.toString()] = indicator.value;
                        } else if (indicator.region.typeRegion == "ESTADO") {
                            estadoArray[indicator.region.geoCode.toString()] = indicator.value;
                            return;
                        }
                    });

                    itensSelect[0] = '<option value="1">Estado</option>';
                    itensSelect[1] = '<option value="2">Municipio</option>';

                    if (estadoArray.length > 0) {
						if (municipioArray.length < 1){
							delete itensSelect[1];
						}
						makeChart(1);
					} else if (municipioArray.length > 0) {
                        delete itensSelect[0];
                        makeChart(2);
                    } else {
                        console.log("Empty DATAJSON")
                    }

                    // html do SELECT
                    var selectRangeMapHtml = '<div class="input-group input-group-sm mb-3">' +
                        '<div class="input-group-prepend">' +
                        '<span style="margin-right:5px;" class="input-group-text fa fa-map input-leaflet" id="basic-addon1"></span>' +
                        '</div>' +
                        '<select onchange="rangeMap(this)" style="border-radius: 0 5px 5px 0; border-left:0;">';

                    itensSelect.forEach(function (iten) {
                        selectRangeMapHtml += iten;
                    });

                    selectRangeMapHtml += '</select>' +
                        '</div>';
                    // html do SELECT

                    // indicador Map control
                    indicadorMapControl = L.control({position: 'topright'});
                    indicadorMapControl.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'indicadorMapControl');
                        this._div.innerHTML = '<div style="cursor: pointer;color:#59C9A8; font-size:16px;" onclick="infoAboutIndicator()" class="" id="indicadorMapControl" title="Menu">' +
                            '<span class="robotoFamily filtro-selecionado">' +
                            dataJson[0].group.name + ' <span style="background-color: #59C9A8; padding:3.5px 6.5px; color: white; border-radius: 4px; font-size:8px; position:relative;top: -2.5px;" class="fa fa-info"></span>' +
                            '</span></div>';

                        $("#footer-sidebar-filtros .indicador").html(this._div.innerHTML);

                        L.DomEvent.addListener(this._div, 'dblclick', L.DomEvent.stop);
                        L.DomEvent.addListener(this._div, 'mousedown', L.DomEvent.stop);
                        L.DomEvent.addListener(this._div, 'mouseup', L.DomEvent.stop);

                        return this._div;
                    }
                    indicadorMapControl.addTo(map);

                    // filtro Map control
                    filtroMapControl = L.control({position: 'topright'});
                    filtroMapControl.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'filtroMapControl');

                        if (filtrosId.size !== 0) {
                            this._div.innerHTML = loadFiltrosSelecionados();
                        }

                        L.DomEvent.addListener(this._div, 'dblclick', L.DomEvent.stop);
                        L.DomEvent.addListener(this._div, 'mousedown', L.DomEvent.stop);
                        L.DomEvent.addListener(this._div, 'mouseup', L.DomEvent.stop);

                        return this._div;
                    }
                    filtroMapControl.addTo(map);

                    var sliderOpacidade = '<div style="background-color: white;border-radius: 10px;padding: 2px 6px; color: #bdbdbd; width: 156px;">' +
                                          '<i class="fa fa-adjust"></i>&nbsp;' +
                                          '0 <input id="sliderOpacidade" type="range" min="0" max="1" step="0.1" value="0.8" onchange="updateOpacity(this.value)"> 100' +
                                          '</div>';

                    // range bar Map control
                    rangeBarControl = L.control({position: 'bottomright'});
                    rangeBarControl.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'rangeBarControl');
                        this._div.innerHTML = '' +
                            '<i class="fa fa-minus" aria-hidden="true"></i><div class="range-bar">' +
                            '<span class="range-bar-mark"></span>' +
                            '</div><i class="fa fa-plus" aria-hidden="true"></i>' +
                            '<select onchange="changeYear(this)" class="select-year">' +
                                setYears(indicadorAtual) +
                            '</select>' + sliderOpacidade;


                        return this._div;
                    }
                    rangeBarControl.addTo(map);
                    document.getElementsByClassName("rangeBarControl")[0].onmouseover = controlEnter;
                    document.getElementsByClassName("rangeBarControl")[0].onmouseout = controlLeave;

                    // select Map control
                    mapControl = L.control({position: 'bottomleft'});
                    mapControl.onAdd = function (map) {
                        this._div = L.DomUtil.create('div', 'mapControl');
                        this._div.innerHTML = selectRangeMapHtml;

                        L.DomEvent.addListener(this._div, 'dblclick', L.DomEvent.stop);

                        return this._div;
                    }
                    mapControl.addTo(map);

                    document.getElementsByClassName("mapControl")[0].onmouseover = controlEnter;
                    document.getElementsByClassName("mapControl")[0].onmouseout = controlLeave;
                }
            }
        });
    }

    $('#submitFormIndicator').click(function() {

		itensSelect = new Array();

		filtrosId = new Set();
        $('#accordionFilter input:checkbox:checked').map(function(){
            filtrosId.add(parseInt($(this).val()));
        });

        layersId = new Set();
        $('input[name=layerCheckbox]:checkbox:checked').map(function(){
            layersId.add(parseInt($(this).val()));
        });

		markers.clearLayers();
        if(layersId.size != 0){
            layersId.forEach(function (layerId) {
                var strQuery ="?groupId.equals="+layerId+"&";
				$.ajax({
					headers: {
						"Authorization": "Bearer " + apiKey
					},
					url: host+'/api/layers'+strQuery,
					dataType: 'json',
					success: function (data) {
						setLayer(data);
					}
				});
            });
        }

        if(indicadorAtual !== undefined){
            cleanMap();

            group = new L.FeatureGroup();
            $("#loading").show();

            var urlQuery = '';
            if(filtrosId.size === 0){
                urlQuery += host+'/api/indicators?&groupId.equals='+indicadorAtual;
                loadResultMap(urlQuery);

            } else {
                var vetor = new Array();
                filtrosId.forEach(function (filtro) {
                    vetor.push(filtro);
                });
                var stringResult = vetor.join(',');
                urlQuery += host+'/api/indicatorsFilter?&filtersId.in='+stringResult+'&groupId.equals='+indicadorAtual;

                $.ajax({
					headers: {
						"Authorization": "Bearer " + apiKey
					},
                    url: host+'/api/regionsWithFilter?&filtersId.in='+stringResult,
                    dataType: 'json',
                    success: function (dataJson) {
                        filtrosPesquisados = new Map();
                        dataJson.forEach(function (dto) {
                            var contains = filtrosPesquisados.get(dto.geocode);
                            if(contains === undefined){
                                filtrosPesquisados.set(dto.geocode, []);
                                contains = filtrosPesquisados.get(dto.geocode);
                            }

                            contains.push(dto.filtername);
                        });

                        loadResultMap(urlQuery);
                    }
                });
            }
        }

		$(document).ajaxComplete(function() {
			// limpar Map control
			if (typeof(limparMapControl) != "undefined") {
				limparMapControl.remove(map);
			}
			limparMapControl = L.control({position: 'topright'});
			limparMapControl.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'limparMapControl');
				this._div.innerHTML = '<div style="cursor: pointer;color:#FFFFFF; font-size:14px;" onclick="limparMap()" class="" id="limparMapControl" title="Menu">' +
					'<span style="text-decoration: underline;">' +
					'limpar <span class="fa fa-trash-o"></span>' +
					'</span></div>';

				L.DomEvent.addListener(this._div, 'dblclick', L.DomEvent.stop);
				L.DomEvent.addListener(this._div, 'mousedown', L.DomEvent.stop);
				L.DomEvent.addListener(this._div, 'mouseup', L.DomEvent.stop);

				return this._div;
            }

			limparMapControl.addTo(map);
		});


	});

};

function infoAboutIndicator() {

    $('#tituloModal').html("INFORMAÇÕES SOBRE INDICADORES");
    $('#idInfoIndicador').val(indicadorSelecionado);

    $.ajax({
		headers: {
			"Authorization": "Bearer " + apiKey
		},
        url: host+'/api/namesPublic/'+indicadorSelecionado,
        dataType: 'json',
        success: function (dataJson) {
            // create DTO with api name and filters

            var conteudoModal =
                '<div>' +
                '   <div>' +
                '       <div style="margin-bottom: 10px">' +
                '           <label style="margin-right: 5px">' + dataJson.value + ' </label>' +
                // '          <button class="btn btn-outline-info" onclick="loadGraphic(\''+dataJson.name.value+'\')">Ver gráfico</button>' +
                '       <div style="margin-top: 10px" class="infoIndicatorSnippet">' + dataJson.description + '</div>' +
                "       <a href=host+'/api/indicators?&groupId.equals="+indicadorSelecionado+"' download> Download</a>" +
                '       <a href="#" class="mostrarMais"> Ler mais</a>' +
                '   </div>';
            if (filtrosId.size !== 0) {
                conteudoModal +=
                    '<div id="containerDescricaoFiltros">';
                $.ajax({
					headers: {
						"Authorization": "Bearer " + apiKey
					},
                    url: host+'/api/filtersDTO?&id.in='+Array.from(filtrosId).join(','),
                    dataType: 'json',
                    success: function (dataJson) {
                        dataJson.forEach(function (filterInfo) {
                            conteudoModal +=
                                '<div class="card">' +
                                '   <div id="headingFilterInfo' + filterInfo.id + '" data-toggle="collapse" data-target="#collapseFilterInfo' + filterInfo.id + '" aria-expanded="false" aria-controls="collapseFilterInfo' + filterInfo.id + '">' +
                                '       <label class="iconInfoFilter">' + filterInfo.name + '</label>' +
                                '       <i class="fa fa-angle-down"></i>' +
                                '   </div>' +
                                '   <div id="collapseFilterInfo' + filterInfo.id + '" class="collapse" aria-labelledby="headingFilterInfo' + filterInfo.id + '" data-parent="#containerDescricaoFiltros">';
                            conteudoModal +=
                                '       <div class="card-body" style="padding: 0 0 1rem 1rem">' + filterInfo.description + '</div>' +
                                '   </div>' +
                                '</div>';
                        });
                        conteudoModal += '</div> ' +
                            '</div>';
                        $('#modalBody').html(conteudoModal);
                        $('#exampleModal').modal('show');

                        $('.mostrarMais').click(function () {
                            if($('.infoIndicatorSnippet').css('height') != '30px'){
                                $('.infoIndicatorSnippet').stop().animate({height: '30px'}, 200);
                                $(this).text('Ler mais');
                            } else {
                                $('.infoIndicatorSnippet').css({height:'100%'});
                                var xx = $('.infoIndicatorSnippet').height();
                                $('.infoIndicatorSnippet').css({height:'30px'});
                                $('.infoIndicatorSnippet').stop().animate({height: xx}, 400);
                                $(this).text('Ler menos');
                            }
                        });

                        $('#containerDescricaoFiltros .card').on('hidden.bs.collapse', function () {
                            $(this).find( "i" ).removeClass("fa-angle-down");
                            $(this).find( "i" ).addClass("fa-angle-right");
                        });

                        $('#containerDescricaoFiltros .card').on('shown.bs.collapse', function () {
                            $(this).find( "i" ).addClass("fa-angle-down");
                            $(this).find( "i" ).removeClass("fa-angle-right");
                        });
                    }
                });
            } else {
                conteudoModal += '</div>';
                $('#modalBody').html(conteudoModal);
                $('#exampleModal').modal('show');
            }

            $('.mostrarMais').click(function () {
                if($('.infoIndicatorSnippet').css('height') != '30px'){
                    $('.infoIndicatorSnippet').stop().animate({height: '30px'}, 200);
                    $(this).text('Ler mais');
                } else {
                    $('.infoIndicatorSnippet').css({height:'100%'});
                    var xx = $('.infoIndicatorSnippet').height();
                    $('.infoIndicatorSnippet').css({height:'30px'});
                    $('.infoIndicatorSnippet').stop().animate({height: xx}, 400);
                    $(this).text('Ler menos');
                }
            });
        }
    });
}

function loadFiltrosSelecionados(){
    var filtrosSelecionados =
        '<div class="iconFilter float-right" onclick="infoAboutIndicator()" id="filtroMapControl" title="filtro">' +
            '<span class="button-state state-get-center get-center-active robotoFamily">'+
                'Filtros selecionados <span class="fa fa-info"></span>' +
            '</span>'+
        '</div>';

    $("#footer-sidebar-filtros .filtro").html(filtrosSelecionados);

    return filtrosSelecionados;
}
	</script>
</body>
</html>
